---
import hljs from "highlight.js"
import "highlight.js/styles/atom-one-dark.css"

interface Props {
	code: string
	lang?: string
	title?: string
}

const { title = "Bloque de c√≥digo", code, lang } = Astro.props

let detectedLang = lang
let highlighted

if (!detectedLang) {
	try {
		const result = hljs.highlightAuto(code)
		detectedLang = result.language || "plaintext"
		highlighted = result.value
	} catch (e) {
		detectedLang = "plaintext"
		highlighted = hljs.highlight(code, { language: "plaintext" }).value
	}
} else {
	highlighted = hljs.highlight(code, { language: detectedLang }).value
}
---

<div class="code-block">
	<div class="code-title">{title}</div>
	<div class="code-container">
		<button class="copy-button" aria-label="Copiar codigo">
			<svg
				xmlns="http://www.w3.org/2000/svg"
				width="20"
				height="20"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
				stroke-linecap="round"
				stroke-linejoin="round"
			>
				<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
				<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
				></path>
			</svg>
		</button>
		<pre class="hljs code"><code set:html={highlighted} /></pre>
	</div>
</div>

<script>
	document.querySelectorAll(".copy-button").forEach((button) => {
		button.addEventListener("click", async () => {
			const codeContainer = button.closest(".code-container")
			const code = codeContainer?.querySelector("code")?.textContent || ""

			try {
				await navigator.clipboard.writeText(code)

				const svg = button.querySelector("svg")
				const originalHTML = svg?.innerHTML

				if (svg) {
					svg.innerHTML = '<path d="M20 6L9 17l-5-5"></path>'
				}

				setTimeout(() => {
					if (svg && originalHTML) {
						svg.innerHTML = originalHTML
					}
				}, 2000)
			} catch (err) {
				console.error("Failed to copy:", err)
			}
		})
	})
</script>

<style>
	.code-block {
		margin: 1.5rem 0;
		border-radius: 0.5rem;
		overflow: hidden;
		background: #0d1117;
		box-shadow:
			0 4px 6px -1px rgb(0 0 0 / 0.1),
			0 2px 4px -2px rgb(0 0 0 / 0.1);
	}

	.code-title {
		padding: 0.75rem 1rem;
		background: #161b22;
		color: #c9d1d9;
		font-size: 0.875rem;
		font-family: "Cascadia Code", monospace;
		border-bottom: 1px solid #30363d;
	}

	.code-container {
		position: relative;
		padding: 1rem;
	}

	.code-container pre {
		margin: 0;
		padding: 0;
		background: transparent !important;
		overflow-x: auto;
		font-size: 0.875rem;
	}

	.copy-button {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		padding: 0.5rem;
		background: #21262d;
		border: 1px solid #30363d;
		border-radius: 0.375rem;
		color: #c9d1d9;
		cursor: pointer;
		transition: all 0.2s;
		opacity: 0;
		z-index: 10;
	}

	.code-container:hover .copy-button {
		opacity: 1;
	}

	.copy-button:hover {
		background: #30363d;
		border-color: #8b949e;
	}

	.copy-button:active {
		transform: scale(0.95);
	}

	pre > code {
		font-family: "Cascadia Code", monospace;
	}
</style>
